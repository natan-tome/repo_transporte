FROM openjdk:8

WORKDIR /app

# 🛠️ Instala dependências essenciais (wget, unzip, gettext, ruby, build tools)
RUN apt-get update && apt-get install -y \
    wget \
    unzip \
    gettext \
    ruby \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# 🔒 Cria pasta segura pros JARs do Embulk
RUN mkdir -p /opt/embulk

# ⬇️ Baixa o embulk.jar e o jruby-complete.jar (versões fixas pra evitar surpresas)
RUN wget https://github.com/embulk/embulk/releases/download/v0.9.25/embulk-0.9.25.jar -O /opt/embulk/embulk.jar && \
    wget https://repo1.maven.org/maven2/org/jruby/jruby-complete/9.1.15.0/jruby-complete-9.1.15.0.jar -O /opt/embulk/jruby-complete.jar && \
    chmod +x /opt/embulk/embulk.jar

# 🔗 Cria link simbólico pro embulk (chamar de qualquer lugar fica fácil)
RUN ln -s /opt/embulk/embulk.jar /usr/local/bin/embulk && chmod +x /usr/local/bin/embulk

# 🧰 Instala yq pra manipular YAML na linha de comando
RUN wget https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64 -O /usr/bin/yq && \
    chmod +x /usr/bin/yq

# 📦 Instala plugins do embulk (input SQL Server e output Parquet)
RUN java -jar /opt/embulk/embulk.jar gem install embulk-input-sqlserver && \
    java -jar /opt/embulk/embulk.jar gem install embulk-output-parquet

# 📁 Copia tudo do projeto pra dentro do container
COPY . .

# ⚙️ Deixa scripts prontos pra execução (sem erro de permissão)
RUN chmod +x entrypoint.sh scripts/*.sh

# 🚦 Define o entrypoint: tudo começa pelo entrypoint.sh
ENTRYPOINT ["sh", "./entrypoint.sh"]
